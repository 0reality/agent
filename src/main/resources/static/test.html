<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title><!DOCTYPE html>
      <html lang="zh-CN">
      <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>工作流执行监控系统</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #00c9ff;
      --secondary-color: #92fe9d;
      --error-color: #ff416c;
      --warning-color: #ffc107;
      --success-color: #4caf50;
      --info-color: #2196f3;
      --system-color: #9e9e9e;
      --dark-bg: #0f2027;
      --medium-bg: #203a43;
      --light-bg: #2c5364;
      --card-bg: rgba(255, 255, 255, 0.08);
      --text-color: #e0f7ff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
    }

    body {
      background: linear-gradient(135deg, var(--dark-bg), var(--medium-bg), var(--light-bg));
      color: var(--text-color);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: var(--card-bg);
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    h1 {
      font-size: 2.5rem;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 1.1rem;
      opacity: 0.8;
      margin-bottom: 15px;
    }

    .server-info {
      background: rgba(0, 201, 255, 0.1);
      padding: 10px 15px;
      border-radius: 8px;
      display: inline-block;
      margin-top: 10px;
      font-family: monospace;
      border: 1px solid rgba(0, 201, 255, 0.3);
    }

    .control-panel {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 25px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 250px;
    }

    .input-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .input-label {
      font-size: 0.9rem;
      opacity: 0.9;
      min-width: 80px;
    }

    input, select, button, textarea {
      padding: 12px 18px;
      border-radius: 10px;
      border: none;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    input {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(0, 201, 255, 0.3);
    }

    input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 201, 255, 0.2);
    }

    select {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      cursor: pointer;
      border: 1px solid rgba(146, 254, 157, 0.3);
    }

    select option {
      background: var(--medium-bg);
      color: white;
    }

    .btn {
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      color: var(--dark-bg);
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      height: fit-content;
      align-self: center;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 201, 255, 0.4);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-stop {
      background: linear-gradient(90deg, var(--error-color), #ff4b2b);
    }

    .status-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      font-size: 1.1rem;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--error-color);
    }

    .status-dot.connected {
      background: var(--secondary-color);
      box-shadow: 0 0 10px var(--secondary-color);
    }

    .status-dot.connecting {
      background: #ffde59;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .content-wrapper {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }

    .chat-container {
      flex: 2;
      min-width: 300px;
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      height: 600px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .workflow-panel {
      flex: 1;
      min-width: 300px;
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      height: 600px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .panel-title {
      font-size: 1.4rem;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(0, 201, 255, 0.5);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .clear-btn {
      background: rgba(255, 65, 108, 0.2);
      color: var(--error-color);
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .clear-btn:hover {
      background: rgba(255, 65, 108, 0.4);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .workflow-container {
      flex: 1;
      overflow-y: auto;
      padding-right: 5px;
    }

    .chat-messages::-webkit-scrollbar,
    .workflow-container::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track,
    .workflow-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .chat-messages::-webkit-scrollbar-thumb,
    .workflow-container::-webkit-scrollbar-thumb {
      background: rgba(0, 201, 255, 0.5);
      border-radius: 10px;
    }

    /* 聊天消息样式 */
    .message {
      display: flex;
      gap: 10px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.system {
      align-items: flex-start;
    }

    .message.assistant {
      align-items: flex-start;
    }

    .message.user {
      align-items: flex-end;
      flex-direction: row-reverse;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .avatar.system {
      background: rgba(158, 158, 158, 0.3);
      color: var(--system-color);
    }

    .avatar.assistant {
      background: rgba(0, 201, 255, 0.3);
      color: var(--primary-color);
    }

    .avatar.user {
      background: rgba(76, 175, 80, 0.3);
      color: var(--success-color);
    }

    .avatar.tool {
      background: rgba(255, 193, 7, 0.3);
      color: var(--warning-color);
    }

    .avatar.node {
      background: rgba(156, 39, 176, 0.3);
      color: #9c27b0;
    }

    .avatar.error {
      background: rgba(244, 67, 54, 0.3);
      color: var(--error-color);
    }

    .message-content {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .message.system .message-content {
      background: rgba(158, 158, 158, 0.15);
      border: 1px solid rgba(158, 158, 158, 0.3);
    }

    .message.assistant .message-content {
      background: rgba(0, 201, 255, 0.15);
      border: 1px solid rgba(0, 201, 255, 0.3);
    }

    .message.user .message-content {
      background: rgba(76, 175, 80, 0.15);
      border: 1px solid rgba(76, 175, 80, 0.3);
    }

    .message.tool .message-content {
      background: rgba(255, 193, 7, 0.15);
      border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .message.node .message-content {
      background: rgba(156, 39, 176, 0.15);
      border: 1px solid rgba(156, 39, 176, 0.3);
    }

    .message.error .message-content {
      background: rgba(244, 67, 54, 0.15);
      border: 1px solid rgba(244, 67, 54, 0.3);
    }

    .message.thinking .message-content {
      background: rgba(33, 150, 243, 0.15);
      border: 1px solid rgba(33, 150, 243, 0.3);
    }

    .message-time {
      font-size: 0.75rem;
      opacity: 0.6;
      margin-top: 4px;
      text-align: right;
    }

    .message.system .message-time {
      text-align: left;
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .message-body {
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .message-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .message-action-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--text-color);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .message-action-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* 合并消息样式 */
    .merged-message {
      margin-bottom: 15px;
    }

    .merged-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .merged-header:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .merged-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .merged-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .merged-count {
      background: rgba(0, 201, 255, 0.3);
      color: var(--primary-color);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .merged-content {
      padding: 0 12px 12px 12px;
      display: none;
    }

    .merged-content.expanded {
      display: block;
    }

    .merged-message-item {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .merged-message-item:last-child {
      border-bottom: none;
    }

    /* 工作流步骤样式 */
    .workflow-step {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 4px solid rgba(0, 201, 255, 0.5);
      transition: all 0.3s ease;
    }

    .workflow-step.active {
      background: rgba(0, 201, 255, 0.1);
      border-left: 4px solid var(--secondary-color);
      box-shadow: 0 0 15px rgba(0, 201, 255, 0.2);
    }

    .workflow-step.completed {
      background: rgba(76, 175, 80, 0.1);
      border-left: 4px solid var(--success-color);
      opacity: 0.8;
    }

    .step-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .step-number {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--primary-color);
    }

    .step-status {
      font-size: 0.8rem;
      padding: 3px 10px;
      border-radius: 20px;
      background: rgba(255, 193, 7, 0.2);
      color: var(--warning-color);
    }

    .step-status.completed {
      background: rgba(76, 175, 80, 0.2);
      color: var(--success-color);
    }

    .step-node {
      font-size: 0.95rem;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .step-details {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .no-messages, .no-steps {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      opacity: 0.5;
      text-align: center;
    }

    .no-messages i, .no-steps i {
      font-size: 3rem;
      margin-bottom: 15px;
    }

    .stats {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 20px;
    }

    .stat-card {
      flex: 1;
      min-width: 150px;
      background: var(--card-bg);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-top: 5px;
    }

    .conversation-info {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      padding: 10px;
      background: rgba(0, 201, 255, 0.1);
      border-radius: 8px;
      font-size: 0.9rem;
    }

    footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      opacity: 0.7;
      font-size: 0.9rem;
    }

    @media (max-width: 1024px) {
      .content-wrapper {
        flex-direction: column;
      }

      .chat-container, .workflow-panel {
        height: 400px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1><i class="fas fa-stream"></i> 工作流执行监控系统</h1>
    <p class="subtitle">实时监控AI工作流执行进度与状态</p>
    <div class="server-info">
      <i class="fas fa-server"></i> 后端服务: http://localhost:8100/api/workflow
    </div>
  </header>

  <div class="control-panel">
    <div class="input-group">
      <div class="input-row">
        <span class="input-label">提示词:</span>
        <input type="text" id="promptInput" placeholder="请输入工作流提示词" value="分析用户需求并生成报告">
      </div>
      <div class="input-row">
        <span class="input-label">会话ID:</span>
        <input type="number" id="conversationIdInput" placeholder="请输入会话ID（可选）" min="1" value="3">
      </div>
    </div>

    <div class="input-group">
      <button id="startBtn" class="btn">
        <i class="fas fa-play"></i> 启动工作流
      </button>
      <button id="stopBtn" class="btn btn-stop" disabled>
        <i class="fas fa-stop"></i> 停止监控
      </button>
    </div>
  </div>

  <div class="status-indicator">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">未连接</span>
    <div class="conversation-info" id="conversationInfo" style="display: none;">
      <i class="fas fa-comments"></i>
      <span>会话ID: <strong id="currentConversationId">-</strong></span>
    </div>
  </div>

  <div class="content-wrapper">
    <div class="chat-container">
      <div class="panel-title">
        工作流消息
        <span class="clear-btn" id="clearMessagesBtn">
                        <i class="fas fa-trash-alt"></i> 清空消息
                    </span>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="no-messages">
          <i class="fas fa-comment-slash"></i>
          <p>暂无消息，启动工作流后消息将在此显示</p>
          <p style="font-size: 0.9rem; margin-top: 10px;">相同类型的消息会自动合并显示</p>
        </div>
      </div>
    </div>

    <div class="workflow-panel">
      <div class="panel-title">
        工作流步骤
        <span class="clear-btn" id="clearStepsBtn">
                        <i class="fas fa-eraser"></i> 清空步骤
                    </span>
      </div>
      <div class="workflow-container" id="workflowContainer">
        <div class="no-steps">
          <i class="fas fa-project-diagram"></i>
          <p>暂无工作流步骤</p>
        </div>
      </div>
    </div>
  </div>

  <div class="stats">
    <div class="stat-card">
      <div class="stat-value" id="totalMessages">0</div>
      <div class="stat-label">总消息数</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="mergedMessages">0</div>
      <div class="stat-label">合并消息</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="currentStep">0</div>
      <div class="stat-label">当前步骤</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="totalSteps">0</div>
      <div class="stat-label">总步骤数</div>
    </div>
  </div>

  <footer>
    <p>© 2026 工作流监控系统 | 后端端口: 8100 | API路径: /api/workflow</p>
  </footer>
</div>

<script>
  // 全局变量
  let eventSource = null;
  let messages = [];
  let mergedMessages = [];
  let workflowSteps = [];
  let currentConversationId = null;

  // 统计信息
  let stats = {
    totalMessages: 0,
    mergedMessages: 0,
    currentStep: 0,
    totalSteps: 0
  };

  // DOM元素
  const promptInput = document.getElementById('promptInput');
  const conversationIdInput = document.getElementById('conversationIdInput');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const statusDot = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');
  const chatMessages = document.getElementById('chatMessages');
  const workflowContainer = document.getElementById('workflowContainer');
  const clearMessagesBtn = document.getElementById('clearMessagesBtn');
  const clearStepsBtn = document.getElementById('clearStepsBtn');
  const conversationInfo = document.getElementById('conversationInfo');
  const currentConversationIdEl = document.getElementById('currentConversationId');

  // 统计元素
  const totalMessagesEl = document.getElementById('totalMessages');
  const mergedMessagesEl = document.getElementById('mergedMessages');
  const currentStepEl = document.getElementById('currentStep');
  const totalStepsEl = document.getElementById('totalSteps');

  // 消息类型配置
  const messageConfig = {
    'ASSISTANT': {
      avatar: 'fas fa-robot',
      className: 'assistant',
      label: '助理',
      color: 'var(--primary-color)'
    },
    'TOOL_CALL': {
      avatar: 'fas fa-tools',
      className: 'tool',
      label: '工具调用',
      color: 'var(--warning-color)'
    },
    'TOOL_RESPONSE': {
      avatar: 'fas fa-check-circle',
      className: 'tool',
      label: '工具响应',
      color: 'var(--success-color)'
    },
    'NODE': {
      avatar: 'fas fa-code-branch',
      className: 'node',
      label: '节点',
      color: '#9c27b0'
    },
    'THINKING': {
      avatar: 'fas fa-brain',
      className: 'thinking',
      label: '思考',
      color: 'var(--info-color)'
    },
    'ERROR': {
      avatar: 'fas fa-exclamation-circle',
      className: 'error',
      label: '错误',
      color: 'var(--error-color)'
    },
    'SYSTEM': {
      avatar: 'fas fa-cog',
      className: 'system',
      label: '系统',
      color: 'var(--system-color)'
    }
  };

  // 更新状态指示器
  function updateStatus(connected) {
    if (connected === true) {
      statusDot.className = 'status-dot connected';
      statusText.textContent = '已连接';
      statusText.style.color = 'var(--secondary-color)';
    } else if (connected === false) {
      statusDot.className = 'status-dot';
      statusText.textContent = '未连接';
      statusText.style.color = 'var(--error-color)';
    } else {
      statusDot.className = 'status-dot connecting';
      statusText.textContent = '连接中...';
      statusText.style.color = '#ffde59';
    }
  }

  // 更新统计信息
  function updateStats() {
    totalMessagesEl.textContent = stats.totalMessages;
    mergedMessagesEl.textContent = stats.mergedMessages;
    currentStepEl.textContent = stats.currentStep;
    totalStepsEl.textContent = stats.totalSteps;
  }

  // 格式化时间
  function formatTime(date) {
    return date.toLocaleTimeString('zh-CN', {
      hour12: false,
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
  }

  // 添加消息
  function addMessage(type, content) {
    const message = {
      id: Date.now() + Math.random(),
      type: type,
      content: content,
      timestamp: new Date(),
      displayTime: formatTime(new Date())
    };

    messages.push(message);
    stats.totalMessages++;

    // 合并相同类型的连续消息
    mergeMessages();

    updateStats();
    renderMessages();

    // 自动滚动到底部
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // 合并相同类型的连续消息
  function mergeMessages() {
    mergedMessages = [];
    let currentGroup = null;

    for (let i = 0; i < messages.length; i++) {
      const message = messages[i];

      if (!currentGroup || currentGroup.type !== message.type) {
        // 开始新组
        currentGroup = {
          type: message.type,
          messages: [message],
          expanded: false
        };
        mergedMessages.push(currentGroup);
      } else {
        // 添加到当前组
        currentGroup.messages.push(message);
      }
    }

    stats.mergedMessages = mergedMessages.length;
  }

  // 渲染消息
  function renderMessages() {
    if (mergedMessages.length === 0) {
      chatMessages.innerHTML = `
                    <div class="no-messages">
                        <i class="fas fa-comment-slash"></i>
                        <p>暂无消息，启动工作流后消息将在此显示</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">相同类型的消息会自动合并显示</p>
                    </div>
                `;
      return;
    }

    chatMessages.innerHTML = '';

    mergedMessages.forEach((group, groupIndex) => {
      const config = messageConfig[group.type];
      const messageCount = group.messages.length;

      if (messageCount === 1) {
        // 单条消息，直接显示
        const message = group.messages[0];
        renderSingleMessage(message, config);
      } else {
        // 多条消息，显示合并视图
        renderMergedMessage(group, config, groupIndex);
      }
    });
  }

  // 渲染单条消息
  function renderSingleMessage(message, config) {
    const messageElement = document.createElement('div');
    messageElement.className = `message ${config.className}`;
    messageElement.dataset.id = message.id;

    messageElement.innerHTML = `
                <div class="avatar ${config.className}">
                    <i class="${config.avatar}"></i>
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span style="color: ${config.color}">${config.label}</span>
                    </div>
                    <div class="message-body">${formatMessageContent(message.content)}</div>
                    <div class="message-time">${message.displayTime}</div>
                </div>
            `;

    chatMessages.appendChild(messageElement);
  }

  // 渲染合并消息
  function renderMergedMessage(group, config, groupIndex) {
    const messageCount = group.messages.length;
    const firstMessage = group.messages[0];
    const lastMessage = group.messages[messageCount - 1];

    const mergedElement = document.createElement('div');
    mergedElement.className = 'merged-message';
    mergedElement.dataset.groupIndex = groupIndex;

    mergedElement.innerHTML = `
                <div class="merged-header" onclick="toggleMergeGroup(${groupIndex})">
                    <div class="merged-avatar ${config.className}">
                        <i class="${config.avatar}"></i>
                    </div>
                    <div class="merged-info">
                        <span style="color: ${config.color}">${config.label}</span>
                        <span class="merged-count">${messageCount} 条消息</span>
                        <span style="opacity: 0.7; font-size: 0.9rem;">
                            ${firstMessage.displayTime} - ${lastMessage.displayTime}
                        </span>
                    </div>
                    <i class="fas fa-chevron-${group.expanded ? 'up' : 'down'}"></i>
                </div>
                <div class="merged-content ${group.expanded ? 'expanded' : ''}">
                    ${group.messages.map((msg, idx) => `
                        <div class="merged-message-item">
                            <div class="message-body">${formatMessageContent(msg.content)}</div>
                            <div class="message-time" style="text-align: left; margin-top: 4px;">${msg.displayTime}</div>
                        </div>
                    `).join('')}
                </div>
            `;

    chatMessages.appendChild(mergedElement);
  }

  // 切换合并消息的展开/收起状态
  window.toggleMergeGroup = function(groupIndex) {
    const group = mergedMessages[groupIndex];
    group.expanded = !group.expanded;
    renderMessages();
    chatMessages.scrollTop = chatMessages.scrollHeight;
  };

  // 格式化消息内容
  function formatMessageContent(content) {
    // 尝试解析JSON
    try {
      const parsed = JSON.parse(content);
      return `<pre style="white-space: pre-wrap; word-break: break-word;">${JSON.stringify(parsed, null, 2)}</pre>`;
    } catch (e) {
      // 如果不是JSON，直接返回
      return content.replace(/\n/g, '<br>');
    }
  }

  // 添加工作流步骤
  function addWorkflowStep(step, nodeName) {
    const stepObj = {
      step: step,
      node: nodeName,
      timestamp: new Date(),
      status: 'active'
    };

    workflowSteps.push(stepObj);
    stats.currentStep = step;
    stats.totalSteps = Math.max(stats.totalSteps, step);

    // 更新之前步骤的状态为完成
    workflowSteps.forEach((s, index) => {
      if (index < workflowSteps.length - 1) {
        s.status = 'completed';
      }
    });

    updateStats();
    renderWorkflowSteps();

    // 自动滚动到底部
    workflowContainer.scrollTop = workflowContainer.scrollHeight;
  }

  // 渲染工作流步骤
  function renderWorkflowSteps() {
    if (workflowSteps.length === 0) {
      workflowContainer.innerHTML = `
                    <div class="no-steps">
                        <i class="fas fa-project-diagram"></i>
                        <p>暂无工作流步骤</p>
                    </div>
                `;
      return;
    }

    workflowContainer.innerHTML = '';

    workflowSteps.forEach(step => {
      const stepElement = document.createElement('div');
      stepElement.className = `workflow-step ${step.status}`;

      stepElement.innerHTML = `
                    <div class="step-header">
                        <div class="step-number">步骤 ${step.step}</div>
                        <div class="step-status ${step.status}">${step.status === 'active' ? '执行中' : '已完成'}</div>
                    </div>
                    <div class="step-node">${step.node}</div>
                    <div class="step-details">${step.timestamp.toLocaleTimeString('zh-CN')}</div>
                `;

      workflowContainer.appendChild(stepElement);
    });
  }

  // 解析节点步骤消息
  function parseNodeStepMessage(content) {
    // 解析类似 "第1步：节点名称开始执行" 的消息
    const match = content.match(/第(\d+)步：(.+)开始执行/);
    if (match) {
      return {
        step: parseInt(match[1]),
        node: match[2]
      };
    }
    return null;
  }

  // 启动SSE连接
  function startSSEConnection() {
    const prompt = promptInput.value.trim();
    if (!prompt) {
      alert('请输入提示词');
      return;
    }

    const conversationId = conversationIdInput.value.trim();
    currentConversationId = conversationId || Date.now().toString();

    // 更新状态
    updateStatus('connecting');
    startBtn.disabled = true;
    stopBtn.disabled = false;

    // 显示会话信息
    conversationInfo.style.display = 'flex';
    currentConversationIdEl.textContent = currentConversationId;

    // 清空之前的数据
    messages = [];
    mergedMessages = [];
    workflowSteps = [];
    stats = {
      totalMessages: 0,
      mergedMessages: 0,
      currentStep: 0,
      totalSteps: 0
    };
    updateStats();
    renderMessages();
    renderWorkflowSteps();

    // 构建API URL
    const baseUrl = 'http://localhost:8100/api';
    let apiUrl = `${baseUrl}/workflow?prompt=${encodeURIComponent(prompt)}`;
    if (conversationId) {
      apiUrl += `&conversationId=${encodeURIComponent(conversationId)}`;
    }

    // 创建EventSource连接
    eventSource = new EventSource(apiUrl);

    // 添加连接消息
    addMessage('SYSTEM', `已连接到工作流API: ${apiUrl}`);
    addMessage('SYSTEM', `工作流提示词: "${prompt}"`);
    if (conversationId) {
      addMessage('SYSTEM', `会话ID: ${conversationId}`);
    }

    // 处理连接打开
    eventSource.onopen = () => {
      console.log('SSE连接已建立');
      updateStatus(true);
      addMessage('SYSTEM', 'SSE连接已建立，开始接收工作流事件...');
    };

    // 处理消息接收
    eventSource.onmessage = (event) => {
      console.log('收到原始事件:', event);
      // 这里可能根据实际事件结构进行调整
      if (event.data) {
        addMessage('SYSTEM', `收到消息: ${event.data}`);
      }
    };

    // 处理自定义事件
    eventSource.addEventListener('ASSISTANT', (event) => {
      addMessage('ASSISTANT', event.data);
    });

    eventSource.addEventListener('TOOL_CALL', (event) => {
      addMessage('TOOL_CALL', event.data);
    });

    eventSource.addEventListener('TOOL_RESPONSE', (event) => {
      addMessage('TOOL_RESPONSE', event.data);
    });

    eventSource.addEventListener('NODE', (event) => {
      addMessage('NODE', event.data);

      // 解析节点步骤信息
      const stepInfo = parseNodeStepMessage(event.data);
      if (stepInfo) {
        addWorkflowStep(stepInfo.step, stepInfo.node);
      }
    });

    eventSource.addEventListener('THINKING', (event) => {
      addMessage('THINKING', event.data);
    });

    eventSource.addEventListener('ERROR', (event) => {
      addMessage('ERROR', event.data);
    });

    eventSource.addEventListener('SYSTEM', (event) => {
      addMessage('SYSTEM', event.data);
    });

    // 处理连接错误
    eventSource.onerror = (error) => {
      console.error('SSE连接错误:', error);
      updateStatus(false);
      addMessage('ERROR', `SSE连接错误: ${error.type}`);

      // 关闭连接
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }

      startBtn.disabled = false;
      stopBtn.disabled = true;
    };
  }

  // 停止SSE连接
  function stopSSEConnection() {
    if (eventSource) {
      eventSource.close();
      eventSource = null;
      addMessage('SYSTEM', 'SSE连接已手动关闭');
    }

    updateStatus(false);
    startBtn.disabled = false;
    stopBtn.disabled = true;
  }

  // 清空消息
  function clearMessages() {
    if (messages.length === 0) return;

    if (confirm('确定要清空所有消息吗？')) {
      messages = [];
      mergedMessages = [];
      stats.totalMessages = 0;
      stats.mergedMessages = 0;

      updateStats();
      renderMessages();

      addMessage('SYSTEM', '消息列表已清空');
    }
  }

  // 清空工作流步骤
  function clearSteps() {
    if (workflowSteps.length === 0) return;

    if (confirm('确定要清空工作流步骤吗？')) {
      workflowSteps = [];
      stats.currentStep = 0;
      stats.totalSteps = 0;

      updateStats();
      renderWorkflowSteps();

      addMessage('SYSTEM', '工作流步骤已清空');
    }
  }

  // 初始化
  function init() {
    updateStatus(false);
    updateStats();

    // 事件监听器
    startBtn.addEventListener('click', startSSEConnection);
    stopBtn.addEventListener('click', stopSSEConnection);
    clearMessagesBtn.addEventListener('click', clearMessages);
    clearStepsBtn.addEventListener('click', clearSteps);

    // 允许按Enter键启动
    promptInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        startSSEConnection();
      }
    });

    conversationIdInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        startSSEConnection();
      }
    });
  }

  // 页面加载完成后初始化
  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html></title>
</head>
<body>

</body>
</html>