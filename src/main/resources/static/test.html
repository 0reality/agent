<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Workflow SSE Debug</title>

  <!-- Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- ä»£ç é«˜äº® -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background:#f3f4f6;
      padding:20px;
    }

    .chat-box {
      background:white;
      padding:15px;
      height:650px;
      overflow-y:auto;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }

    .block {
      margin-bottom:15px;
      padding:12px;
      border-radius:8px;
    }

    .header {
      font-weight:bold;
      margin-bottom:6px;
      cursor:pointer;
    }

    .content {
      word-break:break-word;
    }

    /* ä¸åŒæ¶ˆæ¯ç±»å‹é¢œè‰² */
    .ASSISTANT { background:#ffffff; color:#111; }
    .SYSTEM { background:#eafaf1; color:#1e8449; }
    .ERROR { background:#fdecea; color:#c0392b; font-weight:bold; }
    .THINKING { background:#f4f6f7; color:#7f8c8d; font-style:italic; }
    .NODE { background:#fef5e7; color:#d35400; }
    .TOOL_CALL { background:#f5eef8; color:#8e44ad; }
    .TOOL_RESPONSE { background:#ebf5fb; color:#2980b9; }

    .collapsed .content {
      display:none;
    }
  </style>
</head>

<body>

<h2>Workflow SSE è°ƒè¯•ç•Œé¢</h2>

<input id="conversationId" value="1" placeholder="conversationId">
<input id="prompt" value="ä½ å¥½" placeholder="prompt">
<button onclick="start()">å¼€å§‹</button>
<button onclick="stop()">åœæ­¢</button>

<div id="chat" class="chat-box"></div>

<script>

  let eventSource = null;
  let lastBlock = null;
  let lastType = null;
  let retryCount = 0;

  const MESSAGE_TYPES = [
    "ASSISTANT",
    "TOOL_CALL",
    "TOOL_RESPONSE",
    "NODE",
    "THINKING",
    "ERROR",
    "SYSTEM"
  ];

  function start() {
    stop();
    document.getElementById("chat").innerHTML = "";
    lastBlock = null;
    lastType = null;
    retryCount = 0;

    const cid = document.getElementById("conversationId").value;
    const prompt = document.getElementById("prompt").value;

    connect(cid, prompt);
  }

  function connect(cid, prompt) {

    const url =
            `http://localhost:8100/api/workflow?conversationId=${cid}&prompt=${encodeURIComponent(prompt)}`;

    eventSource = new EventSource(url);

    MESSAGE_TYPES.forEach(type => {
      eventSource.addEventListener(type, function(event) {
        appendMessage(type, event.data);
      });
    });

    eventSource.onerror = function() {
      stop();

      if (retryCount < 5) {
        retryCount++;
        console.log("é‡è¿ä¸­...");
        setTimeout(() => connect(cid, prompt), 2000);
      } else {
        appendMessage("ERROR", "SSE è¿æ¥å¤±è´¥");
      }
    };
  }

  function stop() {
    if (eventSource) {
      eventSource.close();
      eventSource = null;
    }
  }

  function appendMessage(type, content) {

    const chat = document.getElementById("chat");

    // ===== åŒç±»å‹è‡ªåŠ¨åˆå¹¶ =====
    if (lastType === type && lastBlock) {
      updateContent(lastBlock, content);
      chat.scrollTop = chat.scrollHeight;
      return;
    }

    // ===== åˆ›å»ºæ–°å— =====
    const block = document.createElement("div");
    block.className = `block ${type}`;
    block.rawMarkdown = "";   // ä¿å­˜åŸå§‹æ–‡æœ¬

    const header = document.createElement("div");
    header.className = "header";
    header.textContent = `[${type}]`;

    const contentDiv = document.createElement("div");
    contentDiv.className = "content";

    block.appendChild(header);
    block.appendChild(contentDiv);

    // æŠ˜å é€»è¾‘
    if (["THINKING","TOOL_CALL","TOOL_RESPONSE"].includes(type)) {
      block.classList.add("collapsed");
      header.onclick = () => block.classList.toggle("collapsed");
    }

    chat.appendChild(block);

    updateContent(block, content);

    lastBlock = block;
    lastType = type;

    chat.scrollTop = chat.scrollHeight;
  }

  // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ­£ç¡®æµå¼æ‹¼æ¥ markdown
  function updateContent(block, content) {

    const contentDiv = block.querySelector(".content");

    // 1. æ‹¼æ¥åŸå§‹markdown
    block.rawMarkdown += content;

    // 2. æ•´ä½“é‡æ–°æ¸²æŸ“ï¼ˆé¿å…æ‹†åˆ†ul/pï¼‰
    contentDiv.innerHTML = marked.parse(block.rawMarkdown);

    // 3. ä»£ç é«˜äº®
    document.querySelectorAll('pre code').forEach(el => {
      hljs.highlightElement(el);
    });
  }

</script>

</body>
</html>